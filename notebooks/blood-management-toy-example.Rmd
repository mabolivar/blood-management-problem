---
title: "R Notebook"
output: html_notebook
---

```{r params}
input_name <- "01-toy"
input_path <- "./notebooks/data/toy/"
```


```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(readr)
library(tidyr)
library(purrr)
library(stringr)
library(glue)
library("reticulate") # https://rstudio.github.io/reticulate/index.html
```

```{r read-data}

nodes <- read_csv(glue("{input_path}/{input_name}-nodes.csv"),
                  col_types = cols(
                    node = col_character(),
                    b = col_integer()
                    )
                  ) %>% 
  separate(node, into = c("type", "blood_type", "epoch"), remove = FALSE)

arcs <- read_csv(glue("{input_path}/{input_name}-arcs.csv"),
                 col_types = cols(
                   tail = col_character(),
                   head = col_character(),
                   reward = col_integer()
                   )
                 ) %>%
    separate(tail, into = c("tail_type", "tail_blood_type", "tail_epoch"), remove = FALSE) %>% 
    separate(head, into = c("head_type", "head_blood_type", "head_epoch"), remove = FALSE)
```


```{r network-inputs}
# First epoch
# Create supply dictionaries
supply_nodes <- nodes %>% filter(type == "s", epoch == 1) %>% 
  mutate(node = glue("s_{blood_type}"))
supply <- py_dict(supply_nodes$node, supply_nodes$b)


# Create demand dictionaries
demand_nodes <- nodes %>% filter(type == "d", epoch == 1) %>% 
  mutate(node = glue("d_{blood_type}"),
         b = -1 * b)
demand <- with(demand_nodes, py_dict(node, b))

# List for allowed blood transfers
allowed_blood_transfers <- arcs %>% 
  filter(tail_epoch == 1) %>% 
  mutate(tail = glue("s_{tail_blood_type}"), 
         head = glue("d_{head_blood_type}")) %>% 
  distinct(tail, head) %>% 
  pmap(.f=function(tail, head) {tuple(tail, head)})

rewards <- arcs %>% 
  filter(tail_epoch == 1,
         reward != 0) %>% 
  transmute(tail = glue("s_{tail_blood_type}"), 
         head = glue("d_{head_blood_type}"),
         reward) 
reward_map <- py_dict(pmap(.l = rewards, 
                                         .f=function(tail, head, reward) {tuple(tail, head)}),
                                    rewards$reward)

```

```{python build-network}
# Requirements
supply = {tuple(k.split("_")): v for k, v in r["supply"].items()}
demand = {tuple(k.split("_")): v for k, v in r["demand"].items()}
allowed_blood_transfers = set(
  (tuple(tail.split("_")), tuple(head.split("_")))
  for tail, head in r["allowed_blood_transfers"]
  )
reward_map= {(tuple(k[0].split("_")), tuple(k[1].split("_"))): v for k, v in r["reward_map"].items()}

# Create network
supply_demand_arcs = [(s, d) for s in supply.keys() for d in demand.keys()
                      if (s, d) in allowed_blood_transfers]
supply_nextsupply_arcs = [(s, ("f", s[0], s[1])) for s in supply]
nextsupply_sink_arcs = [(("f", s[0], s[1]), (s[0], s[1], i))
                        for s in supply
                        for i in range(1, supply[s] + 1)]
supplysink_sink = [((s[0], s[1], i), "sink") for s in supply for i in range(1, supply[s] + 1)]
demand_sink_arcs = [(d, "sink") for d in demand]


arcs = supply_demand_arcs + supply_nextsupply_arcs + nextsupply_sink_arcs + supplysink_sink + demand_sink_arcs

head_nodes, tail_nodes = [set(nodes) for nodes in zip(*arcs)]
nodes = set.union(head_nodes, tail_nodes)

b = {**{n: s for n, s in supply.items()},
     **{n: 0 for n, d in demand.items()},
     **{"sink": -1 * sum(supply.values())}}
upper = {
    **{arc: demand[arc[0]] for arc in demand_sink_arcs},
    **{arc: 1 for arc in supplysink_sink}
}
reward = {
    **{arc: reward_map[arc] for arc in supply_demand_arcs},
    **{arc: 0 if arc[0][1] > max_blood_age else self.V[epoch][(arc[0][0], arc[0][1])].get(arc[0][2], 0)
       for arc in supplysink_sink}
}

```

```{python}
import pandas as pd
print(r["nodes"])
```

